name: ODBC Driver for Mac (Self-Hosted Runner)

on: workflow_dispatch

env:
  CI_OUTPUT_PATH: "ci-output"
  ODBC_LIB_PATH: "${{github.workspace}}/build/odbc/lib"
  ODBC_BIN_PATH: "${{github.workspace}}/build/odbc/bin"
  ODBC_BUILD_PATH: "${{github.workspace}}/build/odbc/build"
  AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
  AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}  
  TIMESTREAM_LOG_PATH: "${{github.workspace}}/build/odbc/logs"
  TIMESTREAM_LOG_LEVEL: "4"
  ODBCINSTINI: "${{github.workspace}}/build/odbc/lib/timestream-odbc-install.ini"
  AWS_SHARED_CREDENTIALS_FILE: "${{github.workspace}}/src/tests/input/credentials"
  BIG_TABLE_PAGINATION_TEST_ENABLE: "TRUE"

  # # AAD Test environment variables. Uncomment out to use GitHub secrets to enable AAD integration tests
  # ENABLE_AAD_TEST: "TRUE"
  # AAD_APP_ID: ${{secrets.AAD_APP_ID}}
  # AAD_ROLE_ARN: ${{secrets.AAD_ROLE_ARN}}
  # AAD_IDP_ARN: ${{secrets.AAD_IDP_ARN}}
  # AAD_TENANT: ${{secrets.AAD_TENANT}}
  # AAD_USER: ${{secrets.AAD_USER}}
  # AAD_USER_PWD: ${{secrets.AAD_USER_PWD}}
  # AAD_CLIENT_SECRET: ${{secrets.AAD_CLIENT_SECRET}}

  # # OKTA Test environment variables. Uncomment out to use GitHub secrets to enable AAD integration tests
  # ENABLE_OKTA_TEST: "TRUE"
  # OKTA_HOST: ${{secrets.OKTA_HOST}}
  # OKTA_USER: ${{secrets.OKTA_USER}}
  # OKTA_USER_PWD: ${{secrets.OKTA_USER_PWD}}
  # OKTA_APP_ID: ${{secrets.OKTA_APP_ID}}
  # OKTA_ROLE_ARN: ${{secrets.OKTA_ROLE_ARN}}
  # OKTA_IDP_ARN: ${{secrets.OKTA_IDP_ARN}}  

jobs:
  build-mac-self-host:
    runs-on: [self-hosted, macOS, x64]
    steps:
    - uses: actions/checkout@v2

    - name: remove-unixodbc
      continue-on-error: true
      run: |
        brew unlink unixodbc

    - name: get-dependencies
      run: |
        brew tap homebrew/services
        brew install libiodbc
        brew link --overwrite --force libiodbc
        brew install cmake
        brew install boost

    - name: create-credentials-files
      run: |
        echo "[test-profile]" > ${{github.workspace}}/src/tests/input/credentials
        echo "aws_access_key_id = ${{env.AWS_ACCESS_KEY_ID}}" >> ${{github.workspace}}/src/tests/input/credentials
        echo "aws_secret_access_key = ${{env.AWS_SECRET_ACCESS_KEY}}" >> ${{github.workspace}}/src/tests/input/credentials

        echo "[incomplete-profile]" >> ${{github.workspace}}/src/tests/input/credentials
        echo "aws_access_key_id = ${{env.AWS_ACCESS_KEY_ID}}" >> ${{github.workspace}}/src/tests/input/credentials 

    - name: configure-and-build-driver
      run: |
        ./build_mac_release64.sh

    - name: update-environment-with-ODBC_DRIVER_VERSION
      run: |
        read -r ODBC_DRIVER_VERSION < ./src/ODBC_DRIVER_VERSION.txt
        echo "ODBC_DRIVER_VERSION=$ODBC_DRIVER_VERSION" >> $GITHUB_ENV

    - name: upload-package
      uses: actions/upload-artifact@v3
      with:
        name: AmazonTimestreamODBC-${{env.ODBC_DRIVER_VERSION}}_release64
        path: ./cmake-build64/AmazonTimestreamODBC-${{env.ODBC_DRIVER_VERSION}}.pkg

    # - name: prepare-dsn
    #   run: |
    #     sudo mkdir /Library/ODBC
    #     sudo cp ./src/Tests/Tests/odbc-mac.ini /Library/ODBC/odbc.ini
    #     sudo cp ./src/Tests/Tests/odbcinst-mac.ini /Library/ODBC/odbcinst.ini
    #     mkdir ${{ github.workspace }}/odbc-logs
    - name: register-odbc-driver
      run: |
        chmod +x scripts/register_driver_unix.sh
        ./scripts/register_driver_unix.sh
        
    - name: run-tests
      id: runtests
      run: |
        mkdir -p "${{env.TIMESTREAM_LOG_PATH}}"
        export DYLD_LIBRARY_PATH=${{env.ODBC_LIB_PATH}}:$DYLD_LIBRARY_PATH
        ./build/odbc/bin/timestream-odbc-unit-tests --catch_system_errors=false
        ./build/odbc/bin/timestream-odbc-integration-tests --catch_system_errors=false
      env: 
        ODBCINSTINI: ${{env.ODBCINSTINI}}

    - name: upload-test-file
      if: always() && (steps.runtests.outcome == 'failure')
      uses: actions/upload-artifact@v3
      with:
        name: odbc-test-results
        path: |
          ./odbc_unit_test_result.xml
          ./odbc_test_result.xml
          ./build/odbc/logs/timestream_odbc_*.log

    # - name: print-memory-leak-logs
    #   if: always()
    #   run: |
    #     cat ./leaks_*
    # - name: upload-test-logs
    #   if: failure()
    #   uses: actions/upload-artifact@v3
    #   with:
    #     name: test-logs-mac64
    #     path: |
    #       ${{ github.workspace }}/odbc-logs/
    #       ${{ github.workspace }}/leaks_
    # - name: test
    #   run: |
    #     bash ./run_test_runner.sh
    # - name: build-installer
    #   if: success()
    #   run: |
    #     cd cmake-build64
    #     cmake ../src
    #     make
    #     cpack .
    #     cd ..
    # - name: create-output
    #   if: success()
    #   run: |
    #     mkdir build-output
    #     mkdir test-output
    #     mkdir installer
    #     cp ./build/odbc/lib/*.dylib build-output/
    #     cp ./build/odbc/lib/*.a build-output/
    #     cp ./cmake-build64/*.pkg installer/
    # - name: upload-build
    #   if: success()
    #   uses: actions/upload-artifact@v3
    #   with:
    #     name: mac64-build
    #     path: build-output
    # - name: upload-installer
    #   if: success()
    #   uses: actions/upload-artifact@v3
    #   with:
    #     name: mac64-installer
    #     path: installer
    # - name: upload-test-results
    #   if: success()
    #   uses: actions/upload-artifact@v3
    #   with:
    #     name: mac-test-results
    #     path: test-output

  build-mac-debug-self-host:
    runs-on: [self-hosted, macOS, x64]
    steps:
    - uses: actions/checkout@v2

    - name: run-cppcheck
      run: |
        brew install cppcheck
        sh run_cppcheck.sh

    - name: upload-cppcheck-results
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: cppcheck-results
        path: cppcheck-results.log

    - name: remove-unixodbc
      continue-on-error: true
      run: |
        brew unlink unixodbc

    - name: get-dependencies
      run: |
        brew tap homebrew/services
        brew install libiodbc
        brew link --overwrite --force libiodbc
        brew install cmake
        brew install boost
        brew install gcovr

    - name: create-credentials-files
      run: |
        echo "[test-profile]" > ${{github.workspace}}/src/tests/input/credentials
        echo "aws_access_key_id = ${{env.AWS_ACCESS_KEY_ID}}" >> ${{github.workspace}}/src/tests/input/credentials
        echo "aws_secret_access_key = ${{env.AWS_SECRET_ACCESS_KEY}}" >> ${{github.workspace}}/src/tests/input/credentials

        echo "[incomplete-profile]" >> ${{github.workspace}}/src/tests/input/credentials
        echo "aws_access_key_id = ${{env.AWS_ACCESS_KEY_ID}}" >> ${{github.workspace}}/src/tests/input/credentials

    - name: configure-and-build-driver
      run: |
        ./build_mac_debug64.sh

    - name: update-environment-with-ODBC_DRIVER_VERSION
      run: |
        read -r ODBC_DRIVER_VERSION < ./src/ODBC_DRIVER_VERSION.txt
        echo "ODBC_DRIVER_VERSION=$ODBC_DRIVER_VERSION" >> $GITHUB_ENV

    - name: upload-package
      uses: actions/upload-artifact@v3
      with:
        name: AmazonTimestreamODBC-${{env.ODBC_DRIVER_VERSION}}_debug64
        path: ./cmake-build64/AmazonTimestreamODBC-${{env.ODBC_DRIVER_VERSION}}.pkg

    - name: register-odbc-driver
      run: |
        chmod +x scripts/register_driver_unix.sh
        ./scripts/register_driver_unix.sh

      env:
        RUN_CODE_COVERAGE: ${{ true }}
        BOOST_TEST_CATCH_SYSTEM_ERRORS: no

    - name: run-tests
      id: runtests
      run: |
        mkdir -p "${{env.TIMESTREAM_LOG_PATH}}"
        export DYLD_LIBRARY_PATH=${{env.ODBC_LIB_PATH}}:$DYLD_LIBRARY_PATH
        ./build/odbc/bin/timestream-odbc-unit-tests --catch_system_errors=false
        ./build/odbc/bin/timestream-odbc-integration-tests --catch_system_errors=false
        gcovr -r .. --exclude-directories=cmake-build64/tests/integration-test/CMakeFiles/timestream-odbc-integration-tests.dir$ --exclude-directories=cmake-build64/tests/unit-test/CMakeFiles/timestream-odbc-unit-tests.dir$ --cobertura --output coverage.cobertura.xml
      env: 
        ODBCINSTINI: ${{env.ODBCINSTINI}}

    - name: upload-coverage
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: code-coverage
        path: coverage.cobertura.xml

    - name: upload-test-file
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: odbc-test-results-debug
        path: |
          ./odbc_unit_test_result.xml
          ./odbc_test_result.xml
          ./build/odbc/logs/timestream_odbc_*.log

  comment_PR_mac_coverage:
    runs-on: ubuntu-latest
    needs: build-mac-debug-self-host
    steps:
    - uses: actions/checkout@v2

    - name: Retrieve coverage
      uses: actions/download-artifact@v2
      with:
        name: code-coverage

    - name: Retrieve test results
      uses: actions/download-artifact@v2
      with:
        name: odbc-test-results-debug
        path: test-results

    - name: Code Coverage Summary Report
      uses: irongut/CodeCoverageSummary@v1.2.0
      with:
        filename: coverage.cobertura.xml
        badge: true
        format: markdown
        indicators: true
        output: both

    - name: upload-test-report
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        check_name: "MacOS Big Sur 11 Debug Build (Self Hosted Runner) Unit and Integration Test Results Check"
        comment_title: "MacOS Big Sur 11 Debug Build (Self Hosted Runner) Unit and Integration Test Results"
        junit_files: "test-results/odbc_*test_result.xml"       
    
    - name: Add Header for Code Coverage Summary Report
      run: |
        echo "## MacOS Big Sur 11 Debug Build (Self Hosted Runner) Code Coverage Unit and Integration Test Result" > coverage-cobertura.md
        cat code-coverage-results.md >> coverage-cobertura.md
    
    - name: Add Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        header: macOS
        recreate: true
        path: coverage-cobertura.md
